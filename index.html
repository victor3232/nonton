<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DramaBox Nonton Sederhana</title>
    <style>
        body { font-family: Arial, sans-serif; background: #121212; color: #fff; margin: 0; padding: 0; }
        header { background: #1f1f1f; padding: 20px; text-align: center; }
        h1 { margin: 0; }
        #search-bar { padding: 20px; text-align: center; }
        input[type="text"] { padding: 10px; width: 70%; max-width: 400px; border-radius: 5px 0 0 5px; border: none; }
        button { padding: 10px 20px; background: #ff4444; color: #fff; border: none; cursor: pointer; }
        #search-btn { border-radius: 0 5px 5px 0; }
        #trending-btn, #latest-btn { border-radius: 5px; margin-left: 10px; }
        #drama-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; padding: 20px; }
        .drama-card { background: #1f1f1f; border-radius: 10px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .drama-card:hover { transform: scale(1.05); }
        .drama-card img { width: 100%; height: 280px; object-fit: cover; }
        .drama-info { padding: 10px; text-align: center; }
        .drama-info h3 { margin: 5px 0; font-size: 15px; }
        .drama-info p { margin: 5px 0; font-size: 13px; color: #aaa; }
        #detail-page { display: none; padding: 20px; }
        #episode-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 20px; }
        .episode-btn { background: #333; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        .episode-btn:hover { background: #ff4444; }
        .episode-btn.playing { background: #ff4444; }
        #player { width: 100%; max-width: 900px; margin: 30px auto; text-align: center; }
        video { width: 100%; max-height: 80vh; background: #000; border-radius: 10px; }
        .back-btn { background: #333; padding: 10px 20px; cursor: pointer; display: inline-block; margin-bottom: 20px; border-radius: 5px; }
        .loading { text-align: center; padding: 40px; font-size: 18px; }
        footer { text-align: center; padding: 20px; background: #1f1f1f; font-size: 12px; color: #aaa; }
    </style>
</head>
<body>

    <header>
        <h1>DramaBox Nonton Sederhana</h1>
        <p>Unofficial - API dari https://dramabox-asia.vercel.app</p>
    </header>

    <div id="home-page">
        <div id="search-bar">
            <input type="text" id="search-input" placeholder="Cari judul drama (misal: CEO)">
            <button id="search-btn" onclick="searchDrama()">Cari</button>
            <button id="trending-btn" onclick="loadTrending()">Trending</button>
            <button id="latest-btn" onclick="loadLatest(1)">Terbaru</button>
        </div>

        <div id="drama-list" class="loading">Loading...</div>
    </div>

    <div id="detail-page">
        <div class="back-btn" onclick="backToHome()">‚Üê Kembali</div>
        <div id="drama-detail" style="text-align:center;"></div>
        <h2 style="text-align:center;">Episode</h2>
        <div id="episode-list" class="loading">Loading episode...</div>
        <div id="player"></div>
    </div>

    <footer>
        Website sederhana unofficial untuk nonton short drama DramaBox.<br>
        Tidak menyimpan video. Semua dari sumber eksternal. Untuk pribadi saja.
    </footer>

    <script>
        // Gunakan proxy untuk bypass CORS
        const PROXY = 'https://api.allorigins.win/raw?url=';
        const API_BASE = PROXY + 'https://dramabox-asia.vercel.app/api';

        function backToHome() {
            document.getElementById('home-page').style.display = 'block';
            document.getElementById('detail-page').style.display = 'none';
            document.getElementById('player').innerHTML = '';
        }

        function loadTrending() {
            document.getElementById('drama-list').innerHTML = '<div class="loading">Loading trending...</div>';
            fetch(`${API_BASE}/trending`)
                .then(res => res.json())
                .then(data => displayDramas(data.data || []))
                .catch(err => {
                    document.getElementById('drama-list').innerHTML = '<p>Error: ' + err + ' (Cek koneksi/proxy)</p>';
                });
        }

        function loadLatest(page = 1) {
            document.getElementById('drama-list').innerHTML = '<div class="loading">Loading terbaru...</div>';
            fetch(`${API_BASE}/latest?page=${page}`)
                .then(res => res.json())
                .then(data => displayDramas(data.data || []))
                .catch(err => document.getElementById('drama-list').innerHTML = '<p>Error: ' + err + '</p>');
        }

        function searchDrama() {
            const q = document.getElementById('search-input').value.trim();
            if (!q) return alert('Masukkan kata kunci!');
            document.getElementById('drama-list').innerHTML = '<div class="loading">Mencari...</div>';
            fetch(`${API_BASE}/search?q=${encodeURIComponent(q)}`)
                .then(res => res.json())
                .then(data => displayDramas(data.data || []))
                .catch(err => document.getElementById('drama-list').innerHTML = '<p>Error: ' + err + '</p>');
        }

        function displayDramas(dramas) {
            if (dramas.length === 0) {
                document.getElementById('drama-list').innerHTML = '<p>Tidak ditemukan drama.</p>';
                return;
            }
            let html = '';
            dramas.forEach(drama => {
                const cover = drama.cover || 'https://via.placeholder.com/240x400?text=No+Cover';
                html += `
                    <div class="drama-card" onclick="showDetail('${drama.bookId}')">
                        <img src="${cover}" alt="${drama.judul}" loading="lazy">
                        <div class="drama-info">
                            <h3>${drama.judul || 'Unknown'}</h3>
                            <p>${drama.total_episode || '?? Ep'}</p>
                        </div>
                    </div>`;
            });
            document.getElementById('drama-list').innerHTML = html;
        }

        async function showDetail(bookId) {
            try {
                const res = await fetch(`${API_BASE}/detail?bookId=${bookId}`);
                const data = await res.json();
                const drama = data; // response langsung object, bukan data.data

                let detailHtml = `
                    <h2>${drama.judul || 'Unknown'}</h2>
                    <img src="${drama.cover || ''}" style="max-width:300px; border-radius:10px; margin:10px 0;">
                    <p><strong>Total Episode:</strong> ${drama.total_episode || '??'}</p>
                    <p>${drama.deskripsi || 'Tidak ada deskripsi.'}</p>`;
                document.getElementById('drama-detail').innerHTML = detailHtml;

                // Gunakan episodes array dari API detail
                const episodes = drama.episodes || [];
                let epHtml = '';
                episodes.forEach(ep => {
                    const epNum = parseInt(ep.episode_label);
                    epHtml += `<div class="episode-btn" onclick="playEpisode('${bookId}', ${epNum})">Episode ${epNum}</div>`;
                });
                if (episodes.length === 0) epHtml = '<p>Tidak ada data episode.</p>';
                document.getElementById('episode-list').innerHTML = epHtml;

                document.getElementById('home-page').style.display = 'none';
                document.getElementById('detail-page').style.display = 'block';

                // Auto play episode 1
                if (episodes.length > 0) playEpisode(bookId, 1);
            } catch (err) {
                alert('Error load detail: ' + err);
            }
        }

        async function playEpisode(bookId, episode) {
            // Highlight episode yang diputar
            document.querySelectorAll('.episode-btn').forEach(btn => {
                btn.classList.remove('playing');
                if (btn.textContent.includes(`Episode ${episode}`)) btn.classList.add('playing');
            });

            document.getElementById('player').innerHTML = '<div class="loading">Loading video Episode ' + episode + '...</div>';

            // Bangun URL m3u8 langsung (API stream sering error 400, ini bypass)
            const videoUrl = `https://videoplayback.dramaboxdb.com/${bookId}/${episode}/index.m3u8`;

            const playerHtml = `
                <h3>Sedang memutar: Episode ${episode}</h3>
                <video id="video-player" controls autoplay playsinline>
                    <source src="${videoUrl}" type="application/x-mpegURL">
                    Browser tidak support HLS. Coba browser lain (Chrome/Firefox).
                </video>`;

            document.getElementById('player').innerHTML = playerHtml;

            // Load HLS jika browser support
            if (Hls.isSupported()) {
                const video = document.getElementById('video-player');
                const hls = new Hls();
                hls.loadSource(videoUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            }
        }

        // Load HLS.js untuk support m3u8 di browser
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
        document.head.appendChild(script);

        // Load trending saat buka
        window.onload = loadTrending;
    </script>

</body>
</html>
