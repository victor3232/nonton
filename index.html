<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DramaBox Nonton Sederhana</title>
    <style>
        body { font-family: Arial, sans-serif; background: #121212; color: #fff; margin: 0; padding: 0; }
        header { background: #1f1f1f; padding: 20px; text-align: center; }
        h1 { margin: 0; font-size: 28px; }
        header p { margin: 10px 0 0; font-size: 14px; color: #aaa; }
        #search-bar { padding: 20px; text-align: center; background: #1a1a1a; }
        #search-input { padding: 12px; width: 70%; max-width: 400px; border-radius: 8px 0 0 8px; border: none; font-size: 16px; }
        button { padding: 12px 20px; background: #ff4444; color: #fff; border: none; cursor: pointer; font-size: 16px; }
        #search-btn { border-radius: 0 8px 8px 0; }
        #trending-btn, #latest-btn { border-radius: 8px; margin-left: 10px; }
        #drama-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; padding: 20px; }
        .drama-card { background: #1f1f1f; border-radius: 12px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .drama-card:hover { transform: scale(1.05); }
        .drama-card img { width: 100%; height: 280px; object-fit: cover; }
        .drama-info { padding: 12px; text-align: center; }
        .drama-info h3 { margin: 8px 0; font-size: 16px; }
        .drama-info p { margin: 5px 0; font-size: 14px; color: #ccc; }
        #detail-page { display: none; padding: 20px; }
        #drama-detail { text-align: center; margin-bottom: 30px; }
        #drama-detail img { max-width: 300px; border-radius: 12px; margin: 15px 0; }
        #episode-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-top: 20px; }
        .episode-btn { background: #333; padding: 16px; text-align: center; border-radius: 10px; cursor: pointer; transition: background 0.2s; font-size: 14px; }
        .episode-btn:hover { background: #ff4444; }
        .episode-btn.playing { background: #ff4444; font-weight: bold; }
        #player { width: 100%; max-width: 900px; margin: 30px auto; text-align: center; }
        video { width: 100%; max-height: 80vh; background: #000; border-radius: 12px; }
        .back-btn { background: #333; padding: 12px 24px; cursor: pointer; display: inline-block; margin-bottom: 20px; border-radius: 8px; font-size: 16px; }
        .loading { text-align: center; padding: 50px; font-size: 18px; color: #aaa; }
        footer { text-align: center; padding: 30px; background: #1f1f1f; font-size: 13px; color: #777; margin-top: 50px; }
    </style>
</head>
<body>

    <header>
        <h1>DramaBox Nonton Sederhana</h1>
        <p>Unofficial ‚Ä¢ Streaming Short Drama Gratis ‚Ä¢ API dari restxdb.onrender.com</p>
    </header>

    <div id="home-page">
        <div id="search-bar">
            <input type="text" id="search-input" placeholder="Cari judul drama (contoh: CEO, cinta)">
            <button id="search-btn" onclick="searchDrama()">Cari</button>
            <button id="trending-btn" onclick="loadTrending()">Trending</button>
            <button id="latest-btn" onclick="loadLatest(1)">Terbaru</button>
        </div>

        <div id="drama-list" class="loading">Loading drama...</div>
    </div>

    <div id="detail-page">
        <div class="back-btn" onclick="backToHome()">‚Üê Kembali</div>
        <div id="drama-detail"></div>
        <h2 style="text-align:center; margin:30px 0 10px;">Daftar Episode</h2>
        <div id="episode-list" class="loading">Loading episode...</div>
        <div id="player"></div>
    </div>

    <footer>
        Website sederhana unofficial untuk nonton short drama dari DramaBox.<br>
        Tidak menyimpan video apa pun ‚Äî semua streaming langsung dari sumber resmi.<br>
        Dibuat untuk keperluan pribadi & eksperimen. Gunakan dengan bijak.
    </footer>

    <script>
        // API utama baru (gateway Dramabox)
        const API_BASE = 'https://restxdb.onrender.com/api';
        const LANG = 'in';

        // Menyimpan list drama terakhir untuk dipakai di detail
        let currentDramas = [];

        function backToHome() {
            document.getElementById('home-page').style.display = 'block';
            document.getElementById('detail-page').style.display = 'none';
            document.getElementById('player').innerHTML = '';
        }

        // Trending = rank/populer
        function loadTrending() {
            document.getElementById('drama-list').innerHTML = '<div class="loading">Loading trending...</div>';
            fetch(`${API_BASE}/rank/1?lang=${LANG}`)
                .then(res => res.json())
                .then(json => {
                    const list = (json.data && json.data.list) ? json.data.list : [];
                    displayDramas(list);
                })
                .catch(err => {
                    document.getElementById('drama-list').innerHTML = `<p>Error load trending: ${err}. Coba refresh.</p>`;
                });
        }

        // Terbaru = newlist
        function loadLatest(page = 1) {
            document.getElementById('drama-list').innerHTML = '<div class="loading">Loading terbaru...</div>';
            fetch(`${API_BASE}/new/${page}?lang=${LANG}&pageSize=20`)
                .then(res => res.json())
                .then(json => {
                    const list = (json.data && json.data.list) ? json.data.list : [];
                    displayDramas(list);
                })
                .catch(err => {
                    document.getElementById('drama-list').innerHTML = `<p>Error: ${err}</p>`;
                });
        }

        // Pencarian judul
        function searchDrama() {
            const q = document.getElementById('search-input').value.trim();
            if (!q) return alert('Masukkan kata kunci pencarian!');
            document.getElementById('drama-list').innerHTML = '<div class="loading">Mencari...</div>';

            // Endpoint search baru: /api/search/{keyword}/{page}?lang=in
            fetch(`${API_BASE}/search/${encodeURIComponent(q)}/1?lang=${LANG}`)
                .then(res => res.json())
                .then(json => {
                    const list = (json.data && json.data.list) ? json.data.list : [];
                    displayDramas(list);
                })
                .catch(err => {
                    document.getElementById('drama-list').innerHTML = `<p>Error pencarian: ${err}</p>`;
                });
        }

        // Render daftar drama di halaman utama
        function displayDramas(dramas) {
            currentDramas = dramas || [];

            if (!dramas || dramas.length === 0) {
                document.getElementById('drama-list').innerHTML = '<p>Tidak ada drama ditemukan.</p>';
                return;
            }

            let html = '';
            dramas.forEach((drama, index) => {
                const cover = drama.cover || 'https://via.placeholder.com/240x400?text=No+Cover';
                const title = drama.bookName || drama.judul || 'Unknown';
                const totalEp = drama.chapterCount || drama.total_episode || '?? Episode';

                html += `
                    <div class="drama-card" onclick="showDetail(${index})">
                        <img src="${cover}" alt="${title}" loading="lazy">
                        <div class="drama-info">
                            <h3>${title}</h3>
                            <p>${totalEp}</p>
                        </div>
                    </div>`;
            });
            document.getElementById('drama-list').innerHTML = html;
        }

        // Halaman detail + ambil daftar episode dari /chapters
        async function showDetail(index) {
            const drama = currentDramas[index];
            if (!drama) {
                alert('Data drama tidak ditemukan.');
                return;
            }

            const bookId = drama.bookId;
            const title = drama.bookName || drama.judul || 'Unknown';
            const cover = drama.cover || '';
            const totalEpText = drama.chapterCount || drama.total_episode || '??';
            const intro = drama.introduction || drama.deskripsi || 'Tidak ada deskripsi.';

            let detailHtml = `
                <h2>${title}</h2>
                ${cover ? `<img src="${cover}" alt="${title}">` : ''}
                <p><strong>Total Episode:</strong> ${totalEpText}</p>
                <p>${intro}</p>`;
            document.getElementById('drama-detail').innerHTML = detailHtml;

            document.getElementById('episode-list').innerHTML = '<div class="loading">Loading episode...</div>';
            document.getElementById('player').innerHTML = '';

            // Pindah ke halaman detail
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('detail-page').style.display = 'block';

            try {
                // Ambil daftar episode dari endpoint chapters baru
                const res = await fetch(`${API_BASE}/chapters/${bookId}?lang=${LANG}`);
                const json = await res.json();
                const chapters = (json.data && json.data.chapterList) ? json.data.chapterList : [];

                if (!chapters.length) {
                    document.getElementById('episode-list').innerHTML = '<p>Tidak ada episode tersedia.</p>';
                    return;
                }

                let epHtml = '';
                chapters.forEach((ch, i) => {
                    const epNumber = (typeof ch.chapterIndex === 'number') ? ch.chapterIndex + 1 : (i + 1);
                    const isVip = ch.isCharge === 1;
                    epHtml += `
                        <div class="episode-btn" onclick="playEpisode('${bookId}', ${ch.chapterIndex}, ${i})">
                            Episode ${epNumber}${isVip ? ' üîí' : ''}
                        </div>`;
                });
                document.getElementById('episode-list').innerHTML = epHtml;

                // Auto play episode pertama (index 0)
                playEpisode(bookId, chapters[0].chapterIndex, 0);
            } catch (err) {
                document.getElementById('episode-list').innerHTML = `<p>Gagal load episode: ${err}</p>`;
            }
        }

        // Memutar episode via endpoint watch baru
        async function playEpisode(bookId, chapterIndex, buttonPosition) {
            // Highlight episode aktif
            document.querySelectorAll('.episode-btn').forEach(btn => btn.classList.remove('playing'));
            const buttons = document.querySelectorAll('.episode-btn');
            if (buttons[buttonPosition]) buttons[buttonPosition].classList.add('playing');

            document.getElementById('player').innerHTML =
                '<div class="loading">Mengambil link video Episode ' + (chapterIndex + 1) + '...</div>';

            try {
                // Endpoint baru: /api/watch/{bookId}/{chapterIndex}?lang=in&source=...
                const res = await fetch(
                    `${API_BASE}/watch/${bookId}/${chapterIndex}?lang=${LANG}&source=web_player`
                );
                if (!res.ok) throw 'Server error atau rate limit';
                const json = await res.json();

                if (!json.success || !json.data) throw 'API response tidak success';

                const videoData = json.data;
                const qualities = videoData.qualities || [];
                const defaultQ = qualities.find(q => q.isDefault === 1) || qualities[0];

                const videoUrl = (defaultQ && defaultQ.videoPath) || videoData.videoUrl;
                if (!videoUrl) throw 'URL video tidak ditemukan';

                const playerHtml = `
                    <h3>Sedang memutar: Episode ${chapterIndex + 1}</h3>
                    <video id="video-player" controls autoplay playsinline>
                        <source src="${videoUrl}" type="video/mp4">
                        Browser Anda tidak mendukung pemutaran video.
                    </video>`;

                document.getElementById('player').innerHTML = playerHtml;
            } catch (err) {
                document.getElementById('player').innerHTML = `
                    <p style="color:#ff8888;">Gagal memuat video Episode ${chapterIndex + 1}<br>
                    ${err}<br><br>
                    Solusi: Coba episode lain atau refresh halaman (API gratis bisa kena rate limit).</p>`;
            }
        }

        // Mulai dengan trending saat halaman dibuka
        window.onload = () => {
            loadTrending();
        };
    </script>

</body>
</html>
